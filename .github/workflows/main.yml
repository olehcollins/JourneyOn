name: Journey On. Build, Test and Deploy to Elastic Beanstalk

on:
  push:
    branches:
      - main

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: â³ Check out repository
        uses: actions/checkout@v3

      - name: ğŸ”§ Set up .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: ğŸ“¦ Restore dependencies
        run: dotnet restore

      - name: ğŸ› ï¸ Build solution
        run: dotnet build --no-restore --configuration Release

      - name: ğŸ§ª Run unit tests
        run: dotnet test --no-build --verbosity normal

  deploy:
    name: Deploy to Elastic Beanstalk
    needs: build-and-test
    runs-on: ubuntu-latest
    if: ${{ always() && needs.build-and-test.result == 'success' }}
    steps:
      - name: â³ Check out repository
        uses: actions/checkout@v3

      - name: ğŸ“¦ Set up .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: ğŸ“‚ Publish application
        run: |
          dotnet publish --configuration Release \
            --output ./publish

      - name: ğŸ—œï¸ Zip application bundle
        run: |
          cd publish
          zip -r ../app.zip .

      - name: ğŸš€ Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v20
        with:
          aws_access_key:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key:     ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name:   ${{ secrets.EB_APPLICATION_NAME }}
          environment_name:   ${{ secrets.EB_ENVIRONMENT_NAME }}
          region:             ${{ secrets.AWS_REGION }}
          version_label:      ${{ github.sha }}
          bucket_name:        ${{ secrets.EB_S3_BUCKET }}       # optional: if you have a dedicated S3 bucket
          bucket_key:         app-${{ github.sha }}.zip
          deployment_package: app.zip
